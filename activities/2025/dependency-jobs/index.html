<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<title>WAVLab | Submit dependency jobs in SLURM</title>
<meta name="description" content="Webpage of Watanabe's Audio and Voice (WAV) Lab
">

<!-- Open Graph -->


<!-- Bootstrap & MDB -->
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet" integrity="sha512-MoRNloxbStBcD8z3M/2BmnT+rg4IsMxPkXaGh2zD6LGNNFE80W3onsAhRcMAMrSoyWL9xD7Ert0men7vR8LUZg==" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/css/mdb.min.css" integrity="sha512-RO38pBRxYH3SoOprtPTD86JFOclM51/XTIdEPh5j8sj4tp8jmQIx26twG52UaLi//hQldfrh7e51WzP9wuP32Q==" crossorigin="anonymous" />

<!-- Fonts & Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css"  integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.0/css/academicons.min.css" integrity="sha512-W4yqoT1+8NLkinBLBZko+dFB2ZbHsYLDdr50VElllRcNt2Q4/GSs6u71UHKxB7S6JEMCp5Ve4xjh3eGQl/HRvg==" crossorigin="anonymous">
<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons">

<!-- Code Syntax Highlighting -->
<link rel="stylesheet" href="https://raw.githubusercontent.com/repo/jwarby/jekyll-pygments-themes/master/github.css" />

<!-- Styles -->

<link rel="icon" href="/assets/img/favicon.png">

<link rel="stylesheet" href="/assets/css/main.css">

<link rel="canonical" href="/activities/2025/dependency-jobs/">

<!-- JQuery -->
<!-- jQuery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>


<!-- Theming-->

  <script src="/assets/js/theme.js"></script>
  <!-- Load DarkMode JS -->
<script src="/assets/js/dark_mode.js"></script>






    
<!-- MathJax -->
<script type="text/javascript">
  window.MathJax = {
    tex: {
      tags: 'ams'
    }
  };
</script>
<script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.1.2/es5/tex-mml-chtml.js"></script>
<script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>


  </head>

  <body class="fixed-top-nav ">

    <!-- Header -->

    <header>

    <!-- Nav Bar -->
    <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top">
    <div class="container">
      
      <a class="navbar-brand title font-weight-lighter" href="/">
       WAVLab
      </a>
      
      <!-- Navbar Toggle -->
      <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar top-bar"></span>
        <span class="icon-bar middle-bar"></span>
        <span class="icon-bar bottom-bar"></span>
      </button>
      <div class="collapse navbar-collapse text-right" id="navbarNav">
        <ul class="navbar-nav ml-auto flex-nowrap">
          <!-- About -->
          <li class="nav-item ">
            <a class="nav-link" href="/">
              About
              
            </a>
          </li>
          <!-- Blog -->
          <li class="nav-item ">
            <a class="nav-link" href="/blog/">
              Activities
              
            </a>
          </li>
          <!-- Other pages -->
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/members/">
                Members
                
              </a>
          </li>
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/publications/">
                Publications
                
              </a>
          </li>
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/open_source">
                Open-source
                
              </a>
          </li>
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/courses/">
                Courses
                
              </a>
          </li>
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/sponsors/">
                Sponsors
                
              </a>
          </li>
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/info/">
                Info
                
              </a>
          </li>
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/positions/">
                Positions
                
              </a>
          </li>
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/speech_lunch">
                Speech Lunch
                
              </a>
          </li>
          
          
          
          
            <div class = "toggle-container">
              <a id = "light-toggle">
                  <i class="fas fa-moon"></i>
                  <i class="fas fa-sun"></i>
              </a>
            </div>
          
        </ul>
      </div>
    </div>
  </nav>

</header>


    <!-- Content -->

    <div class="container mt-5">
      

<div class="post">

  <header class="post-header">
    <h1 class="post-title">Submit dependency jobs in SLURM</h1>
    <p class="post-meta">April 22, 2025</p>
  </header>

  <article class="post-content">
    <h2 id="submitting-dependency-jobs-in-slurm">Submitting Dependency Jobs in SLURM</h2>

<h3 id="overview">Overview</h3>

<p>When running computationally intensive tasks like speech recognition training in ESPnet, you may need to split your work into sequential jobs. SLURMâ€™s dependency feature allows you to create a chain of jobs where each job starts only after its predecessor completes successfully.</p>

<h3 id="what-are-dependency-jobs">What are Dependency Jobs?</h3>

<p>Dependency jobs in SLURM are jobs that have a relationship with other jobs in the queue. The most common dependency type is <code class="language-plaintext highlighter-rouge">afterany</code>, which means a job will start only after the specified job has completed (regardless of the completion state).</p>

<h3 id="automated-dependency-job-submission-script">Automated Dependency Job Submission Script</h3>

<p>The following script allows you to automatically submit multiple sequential jobs, with each job depending on the successful completion of the previous job. This is particularly useful for ESPnet experiments where you might find sbatch scripts in <code class="language-plaintext highlighter-rouge">exp/&lt;exp_dir&gt;/q/train.sh</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="c"># Number of sequential jobs to submit</span>
<span class="nv">NUM_JOBS</span><span class="o">=</span>5

<span class="c"># Ask user to paste their SLURM command</span>
<span class="nb">echo</span> <span class="s2">"Paste your SLURM command:"</span>
<span class="nb">read</span> <span class="nt">-r</span> ORIGINAL_CMD

<span class="c"># Check if the command already contains a dependency flag</span>
<span class="k">if</span> <span class="o">[[</span> <span class="nv">$ORIGINAL_CMD</span> <span class="o">==</span> <span class="k">*</span><span class="s2">"--dependency"</span><span class="k">*</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
  <span class="c"># Extract the existing dependency</span>
  <span class="nv">DEPENDENCY</span><span class="o">=</span><span class="si">$(</span><span class="nb">echo</span> <span class="nv">$ORIGINAL_CMD</span> | <span class="nb">grep</span> <span class="nt">-o</span> <span class="nt">--</span> <span class="s2">"--dependency=[^ ]*"</span><span class="si">)</span>
  <span class="c"># Remove the existing dependency to add our placeholder</span>
  <span class="nv">SBATCH_CMD</span><span class="o">=</span><span class="k">${</span><span class="nv">ORIGINAL_CMD</span><span class="p">/</span><span class="nv">$DEPENDENCY</span><span class="p">/DEPENDENCY_PLACEHOLDER</span><span class="k">}</span>
<span class="k">else</span>
  <span class="c"># Find the position after 'sbatch' to insert our dependency placeholder</span>
  <span class="nv">SBATCH_CMD</span><span class="o">=</span><span class="si">$(</span><span class="nb">echo</span> <span class="nv">$ORIGINAL_CMD</span> | <span class="nb">sed</span> <span class="s1">'s/sbatch /sbatch DEPENDENCY_PLACEHOLDER /'</span><span class="si">)</span>
<span class="k">fi</span>

<span class="c"># Submit the first job (with original dependency if it existed)</span>
<span class="k">if</span> <span class="o">[[</span> <span class="nv">$ORIGINAL_CMD</span> <span class="o">==</span> <span class="k">*</span><span class="s2">"--dependency"</span><span class="k">*</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then
  </span><span class="nv">FIRST_CMD</span><span class="o">=</span><span class="k">${</span><span class="nv">SBATCH_CMD</span><span class="p">/DEPENDENCY_PLACEHOLDER/</span><span class="nv">$DEPENDENCY</span><span class="k">}</span>
<span class="k">else</span>
  <span class="c"># If no original dependency, the first job has no dependency</span>
  <span class="nv">FIRST_CMD</span><span class="o">=</span><span class="k">${</span><span class="nv">SBATCH_CMD</span><span class="p">/DEPENDENCY_PLACEHOLDER/</span><span class="k">}</span>
<span class="k">fi

</span><span class="nv">job_id</span><span class="o">=</span><span class="si">$(</span><span class="nb">eval</span> <span class="s2">"</span><span class="nv">$FIRST_CMD</span><span class="s2">"</span> | <span class="nb">grep</span> <span class="nt">-oP</span> <span class="s1">'(?&lt;=Submitted batch job )\d+'</span><span class="si">)</span>
<span class="nb">echo</span> <span class="s2">"Submitted job 1 with ID: </span><span class="nv">$job_id</span><span class="s2">"</span>

<span class="c"># Submit the remaining jobs with dependencies on the previous job</span>
<span class="k">for</span> <span class="o">((</span><span class="nv">i</span><span class="o">=</span>2<span class="p">;</span> i&lt;<span class="o">=</span>NUM_JOBS<span class="p">;</span> i++<span class="o">))</span><span class="p">;</span> <span class="k">do
  </span><span class="nv">next_cmd</span><span class="o">=</span><span class="k">${</span><span class="nv">SBATCH_CMD</span><span class="p">/DEPENDENCY_PLACEHOLDER/--dependency=afterany</span>:<span class="nv">$job_id</span><span class="k">}</span>
  <span class="nv">job_id</span><span class="o">=</span><span class="si">$(</span><span class="nb">eval</span> <span class="s2">"</span><span class="nv">$next_cmd</span><span class="s2">"</span> | <span class="nb">grep</span> <span class="nt">-oP</span> <span class="s1">'(?&lt;=Submitted batch job )\d+'</span><span class="si">)</span>

  <span class="nb">echo</span> <span class="s2">"Submitted job </span><span class="nv">$i</span><span class="s2"> with ID: </span><span class="nv">$job_id</span><span class="s2">"</span>
<span class="k">done</span>
</code></pre></div></div>

<h3 id="how-to-use-this-script">How to Use This Script</h3>

<ol>
  <li>Save the script above to a file (e.g., <code class="language-plaintext highlighter-rouge">submit_dependency_jobs.sh</code>)</li>
  <li>Make it executable: <code class="language-plaintext highlighter-rouge">chmod +x submit_dependency_jobs.sh</code></li>
  <li>Run the script: <code class="language-plaintext highlighter-rouge">./submit_dependency_jobs.sh</code></li>
  <li>When prompted, paste your sbatch command (e.g., the command from ESPnetâ€™s <code class="language-plaintext highlighter-rouge">exp/&lt;exp_dir&gt;/q/train.sh</code>)</li>
  <li>The script will submit the specified number of jobs in sequence, with each job depending on the completion of the previous one</li>
</ol>

<h3 id="key-features">Key Features</h3>

<ul>
  <li>Handles cases where your original sbatch command already contains a dependency</li>
  <li>Preserves all original parameters of your sbatch command</li>
  <li>Provides feedback with job IDs as each job is submitted</li>
  <li>Customizable number of sequential jobs through the <code class="language-plaintext highlighter-rouge">NUM_JOBS</code> variable</li>
</ul>

<h3 id="common-dependency-types">Common Dependency Types</h3>

<p>While this script uses <code class="language-plaintext highlighter-rouge">afterany</code> (job starts after the previous job completes regardless of exit status), SLURM supports other dependency types:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">after</code>: Start job after specified jobs have begun</li>
  <li><code class="language-plaintext highlighter-rouge">afterok</code>: Start job only if specified jobs completed successfully</li>
  <li><code class="language-plaintext highlighter-rouge">afternotok</code>: Start job only if specified jobs failed</li>
  <li><code class="language-plaintext highlighter-rouge">aftercorr</code>: Start job after specified jobs have terminated with the same exit code</li>
</ul>

<p>Modify the script as needed by changing <code class="language-plaintext highlighter-rouge">afterany</code> to your preferred dependency type.</p>

  </article>

  

</div>

    </div>

    <!-- Footer -->

    
<footer class="fixed-bottom">
  <div class="container mt-0">
    &copy; Copyright 2025   WAV Lab.
    Powered by <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank">GitHub Pages</a>.

    
    
  </div>
</footer>



  </body>

  <!-- Bootsrap & MDB scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.4.4/umd/popper.min.js" integrity="sha512-eUQ9hGdLjBjY3F41CScH3UX+4JDSI9zXeroz7hJ+RteoCaY+GP/LDoM8AO+Pt+DRFw3nXqsjh9Zsts8hnYv8/A==" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha512-M5KW3ztuIICmVIhjSqXe01oV2bpe248gOxqmlcYrEzAvws7Pw3z6BK0iGbrwvdrUQUhi3eXgtxp5I8PDo9YfjQ==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/js/mdb.min.js" integrity="sha512-Mug9KHKmroQFMLm93zGrjhibM2z2Obg9l6qFG2qKjXEXkMp/VDkI4uju9m4QKPjWSwQ6O2qzZEnJDEeCw0Blcw==" crossorigin="anonymous"></script>

  
<!-- Mansory & imagesLoaded -->
<script defer src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>
<script defer src="https://unpkg.com/imagesloaded@4/imagesloaded.pkgd.min.js"></script>
<script defer src="/assets/js/mansory.js" type="text/javascript"></script>


  


<!-- Load Common JS -->
<script src="/assets/js/common.js"></script>


</html>
